<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>トランシーバー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.webrtc.ecl.ntt.com/skyway-latest.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>トランシーバー</h1>
  <button id="talkBtn">話す</button>
  <div id="status">接続中...</div>

  <script>
    const SKYWAY_API_KEY = 'YOUR_API_KEY'; // ←ここに自分のAPIキーを入れる
    const ROOM_NAME = 'culture-fes-room';

    const talkBtn = document.getElementById('talkBtn');
    const status = document.getElementById('status');

    let localStream;
    let peer;
    let room;
    let myId = 'user_' + Math.random().toString(36).substr(2, 9);
    let isTalking = false;
    let currentTalker = null;
    let isReady = false;

    async function getStream() {
      return await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
    }

    async function init() {
      try {
        localStream = await getStream();
        peer = new Peer({ key: SKYWAY_API_KEY, debug: 1 });

        peer.on('open', () => {
          room = peer.joinRoom(ROOM_NAME, {
            mode: 'sfu',
            stream: localStream
          });

          room.on('stream', remoteStream => {
            const audio = new Audio();
            audio.srcObject = remoteStream;
            audio.play();
          });

          room.on('open', () => {
            status.textContent = '接続完了';
            isReady = true;
          });

          room.on('data', ({ src, data }) => {
            if (data.type === 'talker') {
              currentTalker = data.id;
            }
          });

          setInterval(() => {
            if (room) {
              room.send({ type: 'who' });
            }
          }, 1000);
        });
      } catch (e) {
        console.error(e);
        status.textContent = '接続エラー';
      }
    }

    function sendTalker(id) {
      if (room) {
        room.send({ type: 'talker', id });
      }
    }

    function startTalking() {
      if (!isReady) return;
      if (!currentTalker || currentTalker === myId) {
        localStream.getAudioTracks()[0].enabled = true;
        sendTalker(myId);
        isTalking = true;
        talkBtn.classList.add('talking');
        status.textContent = '発話中';
      } else {
        status.textContent = '他の人が発話中';
      }
    }

    function stopTalking() {
      if (!isReady) return;
      localStream.getAudioTracks()[0].enabled = false;
      isTalking = false;
      talkBtn.classList.remove('talking');
      if (currentTalker === myId) sendTalker(null);
      status.textContent = '接続完了';
    }

    talkBtn.addEventListener('mousedown', startTalking);
    talkBtn.addEventListener('mouseup', stopTalking);
    talkBtn.addEventListener('mouseleave', () => {
      if (isTalking) stopTalking();
    });
    talkBtn.addEventListener('touchstart', e => {
      e.preventDefault();
      startTalking();
    });
    talkBtn.addEventListener('touchend', e => {
      e.preventDefault();
      stopTalking();
    });

    init();
  </script>
</body>
</html>
